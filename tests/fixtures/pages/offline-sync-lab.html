<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Offline Sync Lab</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f3f6fa;
      color: #122029;
    }
    main {
      max-width: 720px;
      margin: 24px auto;
      padding: 20px;
      background: #ffffff;
      border: 1px solid #d6e0ea;
      border-radius: 12px;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .pill {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border: 1px solid transparent;
    }
    .online {
      background: #e8f7ee;
      color: #0f5f33;
      border-color: #8ad1a6;
    }
    .offline {
      background: #fdecec;
      color: #8e1d1d;
      border-color: #f3a9a9;
    }
    .syncing {
      background: #eaf2ff;
      color: #11428a;
      border-color: #a8c2f6;
    }
    .queued {
      background: #fff6e6;
      color: #8a5800;
      border-color: #f4cf84;
    }
    .synced {
      background: #eaf9f0;
      color: #0d6936;
      border-color: #9ed9b5;
    }
    .idle {
      background: #f2f4f7;
      color: #44546b;
      border-color: #c5cfda;
    }
    fieldset {
      border: 1px solid #d6e0ea;
      border-radius: 10px;
      padding: 12px;
      margin: 0;
    }
    legend {
      font-weight: 700;
      padding: 0 6px;
    }
    label {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
    }
    button {
      border: 1px solid #0f6a41;
      background: #0f6a41;
      color: #fff;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
    }
    button.secondary {
      border-color: #607a95;
      background: #ffffff;
      color: #1f364d;
    }
    pre {
      margin: 10px 0 0;
      padding: 12px;
      background: #0f1720;
      color: #bfe2ff;
      border-radius: 8px;
      overflow: auto;
      font-size: 12px;
    }
    #submission-status {
      margin-top: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <main>
    <h1>Offline Quiz Sync Lab</h1>
    <p>Submit answers while offline, then reconnect and verify queued sync.</p>

    <div class="row">
      <strong>Connection:</strong>
      <span id="offline-indicator" class="pill online" data-state="online">online</span>
      <strong>Sync:</strong>
      <span id="sync-indicator" class="pill idle" data-state="idle">idle</span>
    </div>

    <form id="quiz-form">
      <fieldset>
        <legend>Quiz Question</legend>
        <p>Which stream format is adaptive by default?</p>
        <label><input data-testid="answer-option" type="radio" name="answer" value="HLS"> HLS</label>
        <label><input data-testid="answer-option" type="radio" name="answer" value="MP4"> MP4</label>
        <label><input data-testid="answer-option" type="radio" name="answer" value="WAV"> WAV</label>
      </fieldset>
      <div class="row" style="margin-top: 12px;">
        <button id="submit-answer" type="submit">Submit Answer</button>
        <button id="flush-sync" class="secondary" type="button">Force Sync</button>
      </div>
    </form>

    <div id="submission-status">No submissions yet.</div>
    <pre id="server-state"></pre>
  </main>

  <script>
    (function () {
      const queueStorageKey = "offline-sync-lab.queue";
      const serverStorageKey = "offline-sync-lab.server";
      const state = {
        queue: [],
        server: { submissions: [] },
        syncHistory: []
      };
      window.__syncLabState = state;

      const offlineIndicator = document.getElementById("offline-indicator");
      const syncIndicator = document.getElementById("sync-indicator");
      const status = document.getElementById("submission-status");
      const serverStateView = document.getElementById("server-state");
      const form = document.getElementById("quiz-form");
      const flushButton = document.getElementById("flush-sync");

      function renderServerState() {
        serverStateView.textContent = JSON.stringify(state.server, null, 2);
      }

      function persistQueue() {
        localStorage.setItem(queueStorageKey, JSON.stringify(state.queue));
      }

      function persistServer() {
        localStorage.setItem(serverStorageKey, JSON.stringify(state.server));
      }

      function loadPersistedState() {
        const queueRaw = localStorage.getItem(queueStorageKey);
        const serverRaw = localStorage.getItem(serverStorageKey);

        if (queueRaw) {
          try {
            const parsed = JSON.parse(queueRaw);
            if (Array.isArray(parsed)) {
              state.queue = parsed;
            }
          } catch (error) {
            state.queue = [];
          }
        }

        if (serverRaw) {
          try {
            const parsed = JSON.parse(serverRaw);
            if (parsed && Array.isArray(parsed.submissions)) {
              state.server = parsed;
            }
          } catch (error) {
            state.server = { submissions: [] };
          }
        }
      }

      function setConnectionState() {
        const online = navigator.onLine;
        offlineIndicator.dataset.state = online ? "online" : "offline";
        offlineIndicator.textContent = online ? "online" : "offline";
        offlineIndicator.className = "pill " + (online ? "online" : "offline");
      }

      function setSyncState(syncState) {
        syncIndicator.dataset.state = syncState;
        syncIndicator.textContent = syncState;
        syncIndicator.className = "pill " + syncState;
        state.syncHistory.push(syncState);
      }

      function flushQueue() {
        if (!navigator.onLine) {
          setSyncState("queued");
          status.textContent = "Still offline. Answers remain queued.";
          return;
        }

        if (state.queue.length === 0) {
          setSyncState("synced");
          status.textContent = "No pending answers. Server is up to date.";
          return;
        }

        setSyncState("syncing");
        status.textContent = "Sync in progress...";

        setTimeout(function () {
          while (state.queue.length > 0) {
            const item = state.queue.shift();
            state.server.submissions.push(item);
          }
          persistQueue();
          persistServer();
          renderServerState();
          setSyncState("synced");
          status.textContent = "Queued answers synced to server state.";
        }, 1200);
      }

      function queueSubmission(answer) {
        const payload = {
          answer: answer,
          submittedAt: new Date().toISOString()
        };

        state.queue.push(payload);
        persistQueue();

        if (!navigator.onLine) {
          setSyncState("queued");
          status.textContent = "Answer queued locally while offline.";
          return;
        }

        flushQueue();
      }

      form.addEventListener("submit", function (event) {
        event.preventDefault();
        const selected = form.querySelector("input[name='answer']:checked");
        if (!selected) {
          status.textContent = "Select an answer before submitting.";
          return;
        }
        queueSubmission(selected.value);
      });

      flushButton.addEventListener("click", function () {
        flushQueue();
      });

      window.addEventListener("online", function () {
        setConnectionState();
        flushQueue();
      });

      window.addEventListener("offline", function () {
        setConnectionState();
        if (state.queue.length > 0) {
          setSyncState("queued");
        }
      });

      loadPersistedState();
      setConnectionState();
      renderServerState();
      setSyncState(state.queue.length > 0 ? "queued" : "idle");
    })();
  </script>
</body>
</html>
