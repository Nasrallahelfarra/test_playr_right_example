<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anti-Cheat Timed Exam Lab</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f2f5f9;
      color: #132233;
    }
    main {
      max-width: 760px;
      margin: 24px auto;
      padding: 22px;
      border: 1px solid #d5dfea;
      border-radius: 12px;
      background: #fff;
    }
    .timer-box {
      display: inline-block;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid #acc4e3;
      background: #ecf3ff;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.04em;
      margin-bottom: 12px;
    }
    .muted {
      color: #44566c;
      font-size: 14px;
    }
    .status {
      margin-top: 10px;
      font-weight: 700;
    }
    ol {
      margin-top: 12px;
      padding-left: 22px;
    }
    li {
      margin: 6px 0;
    }
  </style>
</head>
<body>
  <main>
    <h1>Timed Exam Anti-Cheat Lab</h1>
    <div id="countdown" class="timer-box" data-remaining-ms="0">00:00</div>
    <div id="exam-meta" class="muted"></div>
    <div class="status">Submission: <span id="submission-state" data-state="pending">pending</span></div>
    <div class="status">Visibility Flags: <span id="visibility-flags">0</span></div>
    <ol id="event-log"></ol>
  </main>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const examId = params.get("examId") || "default-exam";
      const durationMs = Number(params.get("durationMs")) || 30 * 60 * 1000;

      const startKey = "anti-cheat.start." + examId;
      const submittedKey = "anti-cheat.submitted." + examId;
      const flagCountKey = "anti-cheat.flags." + examId;

      let startEpochMs = Number(localStorage.getItem(startKey));
      if (!Number.isFinite(startEpochMs) || startEpochMs <= 0) {
        startEpochMs = Date.now();
        localStorage.setItem(startKey, String(startEpochMs));
      }

      let submitted = localStorage.getItem(submittedKey) === "true";
      let visibilityFlags = Number(localStorage.getItem(flagCountKey)) || 0;

      const countdown = document.getElementById("countdown");
      const submissionState = document.getElementById("submission-state");
      const visibilityFlagsEl = document.getElementById("visibility-flags");
      const eventLog = document.getElementById("event-log");
      const examMeta = document.getElementById("exam-meta");

      function formatRemaining(ms) {
        const totalSeconds = Math.max(0, Math.ceil(ms / 1000));
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return String(minutes).padStart(2, "0") + ":" + String(seconds).padStart(2, "0");
      }

      function addLogEntry(text) {
        const item = document.createElement("li");
        item.textContent = new Date().toISOString() + " - " + text;
        eventLog.appendChild(item);
      }

      function markSubmitted() {
        if (submitted) {
          return;
        }
        submitted = true;
        localStorage.setItem(submittedKey, "true");
        submissionState.dataset.state = "auto-submitted";
        submissionState.textContent = "auto-submitted";
        addLogEntry("Timer expired, exam auto-submitted.");
      }

      function renderRemaining() {
        const elapsed = Date.now() - startEpochMs;
        const remaining = Math.max(0, durationMs - elapsed);
        countdown.dataset.remainingMs = String(remaining);
        countdown.textContent = formatRemaining(remaining);
        if (remaining <= 0) {
          markSubmitted();
        }
      }

      document.addEventListener("visibilitychange", function () {
        visibilityFlags += 1;
        localStorage.setItem(flagCountKey, String(visibilityFlags));
        visibilityFlagsEl.textContent = String(visibilityFlags);
        addLogEntry("visibilitychange detected (hidden=" + String(document.hidden) + ").");
      });

      submissionState.dataset.state = submitted ? "auto-submitted" : "pending";
      submissionState.textContent = submitted ? "auto-submitted" : "pending";
      visibilityFlagsEl.textContent = String(visibilityFlags);
      examMeta.textContent =
        "Exam ID: " + examId + " | Duration (ms): " + durationMs + " | Start (epoch): " + startEpochMs;

      window.__antiCheatState = {
        examId: examId,
        durationMs: durationMs,
        startEpochMs: startEpochMs,
        getRemainingMs: function () {
          return Number(countdown.dataset.remainingMs || 0);
        }
      };

      addLogEntry("Exam started from persisted server-side start time.");
      renderRemaining();
      setInterval(renderRemaining, 250);
    })();
  </script>
</body>
</html>
